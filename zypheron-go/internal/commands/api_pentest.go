package commands

import (
	"errors"
	"fmt"
	"time"

	"github.com/AlecAivazis/survey/v2"
	"github.com/AlecAivazis/survey/v2/terminal"
	"github.com/KKingZero/Cobra-AI/zypheron-go/internal/api"
	"github.com/KKingZero/Cobra-AI/zypheron-go/internal/storage"
	"github.com/KKingZero/Cobra-AI/zypheron-go/internal/ui"
	"github.com/KKingZero/Cobra-AI/zypheron-go/internal/validation"
	"github.com/KKingZero/Cobra-AI/zypheron-go/pkg/types"
	"github.com/spf13/cobra"
)

// APIPentestCmd returns the API pentest command
func APIPentestCmd() *cobra.Command {
	var (
		url       string
		timeout   int
		output    string
		assumeYes bool
		noInput   bool
		bola      bool
		bfla      bool
		rateLimit bool
	)

	cmd := &cobra.Command{
		Use:   "api-pentest [url]",
		Short: "API security testing",
		Long:  "Perform API security testing following OWASP API Security Top 10",
		Args:  cobra.MaximumNArgs(1),
		RunE: func(cmd *cobra.Command, args []string) error {
			var targetURL string
			interactive := isInteractive(cmd) && !noInput

			// Get target URL (from args or prompt)
			if len(args) > 0 {
				targetURL = args[0]
			} else if url != "" {
				targetURL = url
			} else {
				if !interactive {
					return fmt.Errorf("URL argument required when running non-interactively")
				}
				prompt := &survey.Input{
					Message: "Enter API base URL:",
				}
				if err := survey.AskOne(prompt, &targetURL, survey.WithValidator(survey.Required)); err != nil {
					if errors.Is(err, terminal.InterruptErr) {
						return fmt.Errorf("URL prompt interrupted")
					}
					return err
				}
			}

			// Validate URL
			if err := validation.ValidateTarget(targetURL); err != nil {
				return fmt.Errorf("invalid URL: %w", err)
			}

			// Print header
			fmt.Printf("\n%s\n", ui.Primary.Sprint("╔═══════════════════════════════════════╗"))
			fmt.Printf("%s\n", ui.Primary.Sprint("║  ZYPHERON API PENTEST                 ║"))
			fmt.Printf("%s\n\n", ui.Primary.Sprint("╚═══════════════════════════════════════╝"))

			// Show scan configuration
			fmt.Printf("\n%s\n", ui.InfoMsg("API Pentest Configuration:"))
			fmt.Println(ui.Separator(60))
			fmt.Printf("  Target:   %s\n", ui.Accent.Sprint(targetURL))
			fmt.Printf("  Timeout:  %s\n", ui.Accent.Sprint(fmt.Sprintf("%ds", timeout)))
			fmt.Printf("  Tests:    ")
			if bola {
				fmt.Printf("%s ", ui.Accent.Sprint("BOLA"))
			}
			if bfla {
				fmt.Printf("%s ", ui.Accent.Sprint("BFLA"))
			}
			if rateLimit {
				fmt.Printf("%s ", ui.Accent.Sprint("RateLimit"))
			}
			if !bola && !bfla && !rateLimit {
				fmt.Printf("%s ", ui.Accent.Sprint("All"))
			}
			fmt.Println()
			fmt.Println(ui.Separator(60))
			fmt.Println()

			// Confirm scan
			confirm := true
			if assumeYes || !interactive {
				confirm = true
			} else {
				confirmPrompt := &survey.Confirm{
					Message: "Start API security scan?",
					Default: true,
				}
				if err := survey.AskOne(confirmPrompt, &confirm); err != nil {
					if errors.Is(err, terminal.InterruptErr) {
						fmt.Println(ui.InfoMsg("Scan cancelled"))
						return nil
					}
					return err
				}
			}

			if !confirm {
				fmt.Println(ui.InfoMsg("Scan cancelled"))
				return nil
			}

			// Create scanner
			scanner := api.NewAPIScanner(targetURL, time.Duration(timeout)*time.Second)

			// Discover endpoints
			fmt.Println(ui.InfoMsg("Discovering API endpoints..."))
			if err := scanner.Discover(); err != nil {
				return fmt.Errorf("endpoint discovery failed: %w", err)
			}

			fmt.Printf("%s Found %d endpoints\n", ui.Success.Sprint("✓"), len(scanner.Endpoints))

			// Run tests
			fmt.Println(ui.InfoMsg("Running security tests..."))
			scanStartTime := time.Now()

			if err := scanner.Scan(); err != nil {
				return fmt.Errorf("scan failed: %w", err)
			}

			// Test BOLA if requested
			if bola || (!bola && !bfla && !rateLimit) {
				fmt.Println(ui.InfoMsg("Testing BOLA (Broken Object Level Authorization)..."))
				// Example BOLA test - would need actual endpoint templates and object IDs
				// This is a placeholder
			}

			// Test BFLA if requested
			if bfla || (!bola && !bfla && !rateLimit) {
				fmt.Println(ui.InfoMsg("Testing BFLA (Broken Function Level Authorization)..."))
				// Example BFLA test - would need actual admin endpoints
				// This is a placeholder
			}

			// Test rate limiting if requested
			if rateLimit || (!bola && !bfla && !rateLimit) {
				fmt.Println(ui.InfoMsg("Testing rate limiting..."))
				// Rate limiting tests are already done in Scan()
			}

			duration := time.Since(scanStartTime)

			// Generate report
			report := scanner.GetReport()
			fmt.Printf("\n%s\n", ui.SuccessMsg(fmt.Sprintf("Scan completed in %.2fs", duration.Seconds())))

			// Display results
			fmt.Printf("\n%s\n", ui.InfoMsg("Scan Results:"))
			fmt.Println(ui.Separator(60))
			fmt.Printf("  Endpoints Tested: %d\n", report["endpoints_tested"].(int))
			fmt.Printf("  Vulnerabilities: %d\n", report["total_vulnerabilities"].(int))
			fmt.Printf("  Critical:        %d\n", report["critical_count"].(int))
			fmt.Println(ui.Separator(60))

			// Display vulnerabilities
			if len(scanner.Vulnerabilities) > 0 {
				fmt.Println()
				fmt.Printf("%s\n", ui.Danger.Sprint("Vulnerabilities Found:"))
				for i, vuln := range scanner.Vulnerabilities {
					fmt.Printf("\n  %d. [%s] %s\n", i+1, vuln.Severity, vuln.Title)
					fmt.Printf("     Endpoint: %s %s\n", vuln.Method, vuln.Endpoint)
					fmt.Printf("     Category: %s\n", vuln.OWASPCategory)
					if len(vuln.Description) > 0 {
						desc := vuln.Description
						if len(desc) > 100 {
							desc = desc[:100] + "..."
						}
						fmt.Printf("     %s\n", ui.Muted.Sprint(desc))
					}
				}
			} else {
				fmt.Println()
				fmt.Printf("%s\n", ui.Success.Sprint("✓ No vulnerabilities found"))
			}

			// Save scan to storage
			scanStore, err := storage.NewScanStorage()
			if err != nil {
				fmt.Println(ui.WarningMsg(fmt.Sprintf("Failed to initialize scan storage: %s", err)))
			} else {
				scanID := storage.GenerateScanID(targetURL, "api-pentest")
				scanResult := &types.ScanResult{
					ID:         scanID,
					Timestamp:  scanStartTime,
					Target:     targetURL,
					Tool:       "api-pentest",
					Output:     fmt.Sprintf("Vulnerabilities: %d", len(scanner.Vulnerabilities)),
					Duration:   duration.Seconds(),
					Success:    true,
					Metadata: map[string]string{
						"type":          "api-pentest",
						"endpoints":     fmt.Sprintf("%d", len(scanner.Endpoints)),
						"vulnerabilities": fmt.Sprintf("%d", len(scanner.Vulnerabilities)),
					},
				}

				for _, vuln := range scanner.Vulnerabilities {
					scanResult.Vulnerabilities = append(scanResult.Vulnerabilities, types.Vulnerability{
						ID:          vuln.VulnID,
						Title:       vuln.Title,
						Description: vuln.Description,
						Severity:    vuln.Severity,
					})
				}

				if err := scanStore.SaveScan(scanResult); err != nil {
					fmt.Println(ui.WarningMsg(fmt.Sprintf("Failed to save scan: %s", err)))
				} else {
					fmt.Println(ui.Muted.Sprint(fmt.Sprintf("Scan saved: %s", scanID)))
				}
			}

			return nil
		},
	}

	cmd.Flags().StringVarP(&url, "url", "u", "", "API base URL")
	cmd.Flags().IntVar(&timeout, "timeout", 30, "Timeout in seconds")
	cmd.Flags().StringVarP(&output, "output", "o", "", "Output file")
	cmd.Flags().BoolVarP(&assumeYes, "yes", "y", false, "Assume yes for confirmation prompts")
	cmd.Flags().BoolVar(&noInput, "no-input", false, "Disable interactive prompts")
	cmd.Flags().BoolVar(&bola, "bola", false, "Test for BOLA (Broken Object Level Authorization)")
	cmd.Flags().BoolVar(&bfla, "bfla", false, "Test for BFLA (Broken Function Level Authorization)")
	cmd.Flags().BoolVar(&rateLimit, "rate-limit", false, "Test for rate limiting")

	return cmd
}

